name: Docker Build Checks

on:
  repository_dispatch:
  workflow_dispatch:
  push:
    paths:
      - '**/Dockerfile'
      - 'docker-compose.yml'
      - 'docker-compose.*.yml'
  pull_request:
    paths:
      - '**/Dockerfile'
      - 'docker-compose.yml'
      - 'docker-compose.*.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docker-build-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: Docker Build Quality Analysis

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check nginx Dockerfile
        run: |
          echo "Checking nginx Dockerfile..."
          docker build --check \
            --build-arg PHP_VERSION=8.4 \
            --build-arg APP_USER=dockerkit \
            --build-arg APP_UID=1000 \
            --build-arg APP_PATH=/var/www \
            --build-arg INSTALL_XDEBUG=false \
            --build-arg INSTALL_MONGO=false \
            --build-arg INSTALL_AMQP=false \
            ./nginx

      - name: Check workspace Dockerfile
        run: |
          echo "Checking workspace Dockerfile..."
          docker build --check \
            --build-arg PHP_VERSION=8.4 \
            --build-arg APP_USER=dockerkit \
            --build-arg APP_UID=1000 \
            --build-arg APP_PATH=/var/www \
            --build-arg INSTALL_XDEBUG=false \
            --build-arg INSTALL_PCOV=false \
            --build-arg INSTALL_MONGO=false \
            --build-arg INSTALL_AMQP=false \
            --build-arg INSTALL_AST=false \
            --build-arg INSTALL_NODE=false \
            --build-arg INSTALL_JAVA=false \
            --build-arg INSTALL_POSTGRES_CLIENT=false \
            --build-arg INSTALL_MYSQL_CLIENT=false \
            ./workspace

      - name: Validate docker-compose files
        run: |
          echo "Validating docker-compose configuration..."
          docker compose config --quiet
